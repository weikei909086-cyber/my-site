<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pi Payment Test</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <h1>Pi Network Payment Test</h1>
  <button class="btn btnHi" id="btnPay">Pay with Pi (1π)</button>

  <script>
    (function () {
      const BACKEND = "https://pi-backend-virid.vercel.app"; // your backend URL

      function toast(msg){ alert(msg); }

      // Initialize Pi SDK
      try { window.Pi && window.Pi.init({ version: "2.0" }); } catch (_) {}

      const btn = document.getElementById("btnPay");
      if (btn) {
        btn.addEventListener("click", async () => {
          const PiRef = window.Pi;
          if (!PiRef) { alert("Open this page inside the Pi Browser app."); return; }

          try {
            // 1) Authenticate with 'payments' scope
            await PiRef.authenticate(["payments"], () => {});

            // 2) Create payment
            const amount = 1;
            const memo = "Pi Cashflow EDU test";

            await PiRef.createPayment(
              { amount, memo, metadata: { game: "cashflow", ts: Date.now() } },
              {
                // 3) Ask backend to approve
                onReadyForServerApproval: async (paymentId) => {
                  const r = await fetch(BACKEND + "/approve", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ paymentId })
                  });
                  if (!r.ok) {
                    const t = await r.text();
                    alert("Approve failed: " + r.status + " " + t);
                    throw new Error("Approve failed");
                  }
                },
                // 4) Ask backend to complete after user confirms in wallet
                onReadyForServerCompletion: async (paymentId, txid) => {
                  const r = await fetch(BACKEND + "/complete", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ paymentId, txid })
                  });
                  if (!r.ok) {
                    const t = await r.text();
                    alert("Complete failed: " + r.status + " " + t);
                    throw new Error("Complete failed");
                  }
                  toast("✅ Payment completed!");
                },
                onCancel: (e) => { console.log("cancel", e); },
                onError:  (e) => { console.error("error", e); alert("Payment error: " + (e?.message || e)); },
              }
            );
          } catch (err) {
            console.error(err);
            alert("Payment flow failed: " + (err?.message || err));
          }
        });
      }
    })();
  </script>
</body>
</html>
