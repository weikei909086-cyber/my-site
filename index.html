<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pi Payment Demo (No-Server)</title>
<style>
  :root{--ok:#d4f7d4;--bad:#ffe0e0;--muted:#666;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:20px;line-height:1.45}
  .row{margin:12px 0}
  button{padding:10px 14px;margin-right:8px;border:1px solid #bbb;border-radius:10px;background:#fafafa}
  #status span{display:inline-block;margin-right:10px;padding:6px 10px;border-radius:8px;background:#eee}
  .ok{background:var(--ok)}
  .bad{background:var(--bad)}
  .hint{font-size:14px;color:var(--muted)}
  pre{white-space:pre-wrap;background:#f6f8fa;padding:12px;border-radius:10px}
</style>
<!-- Pi SDK -->
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <h1>Pi Payment Demo – No Server</h1>

  <div id="status" class="row">
    <span id="sdk">SDK: …</span>
    <span id="browser">Pi Browser: …</span>
  </div>

  <div class="row">
    <button id="openInPi" style="display:none">Open in Pi Browser</button>
    <button id="signInBtn" disabled>Sign in with Pi</button>
    <button id="payBtn" disabled>Test Payment</button>
  </div>

  <div id="log" class="row"><pre></pre></div>

  <p class="hint">
    If <b>Sign in with Pi</b> is disabled, you are not inside the Pi Browser. Open the Pi mobile app → Menu ☰ → <b>Pi Browser</b> → paste your URL.
  </p>

<script>
(function(){
  const logBox = document.querySelector('#log pre');
  const log = (...args)=>{
    console.log(...args);
    logBox.textContent += args.map(a => (typeof a==='object'? JSON.stringify(a): String(a))).join(' ') + "\n";
  };

  const sdkTag = document.getElementById('sdk');
  const browserTag = document.getElementById('browser');
  const signInBtn = document.getElementById('signInBtn');
  const payBtn = document.getElementById('payBtn');
  const openBtn = document.getElementById('openInPi');

  function isPiBrowser(){
    return /PiBrowser/i.test(navigator.userAgent) || (window.Pi && typeof Pi.openShareDialog === 'function');
  }

  function setBadge(el, ok, text){
    el.textContent = text;
    el.className = ok ? 'ok' : 'bad';
  }

  function setup(){
    const sdkLoaded = !!window.Pi;
    setBadge(sdkTag, sdkLoaded, 'SDK: ' + (sdkLoaded ? 'loaded' : 'missing'));

    const inPi = isPiBrowser();
    setBadge(browserTag, inPi, 'Pi Browser: ' + (inPi ? 'YES' : 'NO'));

    if(!inPi){
      // show helper to jump into Pi Browser via deep link
      openBtn.style.display = 'inline-block';
      openBtn.onclick = () => {
        const target = (location.href || '').replace(/^https?:\/\//, '');
        location.href = 'pi://' + target;
      };
    }

    if (!sdkLoaded){
      log('Pi SDK not available.');
      return;
    }

    try{
      // Use Testnet (no real Pi) for this demo. Change to false for Mainnet once approved.
      Pi.init({ version: "2.0", sandbox: true });
      log('Pi.init() done');
    }catch(e){
      log('Pi.init() error:', e);
      return;
    }

    // Only enable sign-in if we are in Pi Browser and the SDK is ready
    signInBtn.disabled = !inPi;

    let currentUser = null;

    signInBtn.addEventListener('click', async () => {
      if(!isPiBrowser()){
        alert('Please open this page inside Pi Browser (from the Pi app).');
        return;
      }
      try{
        const scopes = ['username','payments'];
        currentUser = await Pi.authenticate(scopes, (payment)=>log('Found incomplete payment:', payment));
        log('Signed in as', currentUser && currentUser.user && currentUser.user.username);
        alert('Signed in as ' + (currentUser.user && currentUser.user.username));
        payBtn.disabled = false;
      }catch(e){
        log('Auth error:', e);
        alert('Auth error: ' + (e && e.message ? e.message : e));
      }
    });

    payBtn.addEventListener('click', async ()=>{
      try{
        await Pi.createPayment({
          amount: 1,
          memo: "Test Payment (no-server)",
          metadata: { demo: true, ts: Date.now() }
        }, {
          onReadyForServerApproval: (paymentId)=>{
            log('Ready for approval:', paymentId);
            alert('Ready for approval (no server action needed): ' + paymentId);
          },
          onReadyForServerCompletion: (paymentId)=>{
            log('Ready for completion:', paymentId);
            alert('Ready for completion (no server action needed): ' + paymentId);
          },
          onCancel: (paymentId)=>{ log('Cancelled:', paymentId); alert('Payment cancelled'); },
          onError: (error, payment)=>{ log('Payment error:', error, payment); alert('Payment error: ' + error); }
        });
      }catch(e){
        log('createPayment error:', e);
        alert('createPayment error: ' + (e && e.message ? e.message : e));
      }
    });
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', setup);
  } else {
    setTimeout(setup, 100);
  }
})();
</script>
</body>
</html>
