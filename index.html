<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cashflow App – Pi Auth & Payment</title>
<style>
  :root{--ok:#d4f7d4;--bad:#ffe0e0;--muted:#666;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:20px;line-height:1.45}
  h1{margin:0 0 8px}
  .row{margin:12px 0}
  button{padding:10px 14px;margin:6px 8px 6px 0;border:1px solid #bbb;border-radius:10px;background:#fafafa;cursor:pointer}
  button[disabled]{opacity:.5;cursor:not-allowed}
  #status span{display:inline-block;margin-right:10px;margin-bottom:6px;padding:6px 10px;border-radius:8px;background:#eee}
  .ok{background:var(--ok)}
  .bad{background:var(--bad)}
  pre{white-space:pre-wrap;background:#f6f8fa;padding:12px;border-radius:10px;min-height:100px}
</style>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <h1>Cashflow App – Pi Auth & Payment</h1>
  <div id="status" class="row">
    <span id="sdk">SDK: …</span>
    <span id="browser">Pi Browser: …</span>
    <span id="domain"></span>
  </div>

  <div class="row">
    <button id="btnSignIn" disabled>Sign in with Pi</button>
    <button id="btnPay" disabled>Make Payment</button>
  </div>

  <div id="log" class="row"><pre></pre></div>

<script>
(function(){
  const logBox = document.querySelector('#log pre');
  const log = (...args)=>{
    console.log(...args);
    logBox.textContent += args.map(a => (typeof a==='object'? JSON.stringify(a): String(a))).join(' ') + "\n";
  };

  const sdkTag = document.getElementById('sdk');
  const browserTag = document.getElementById('browser');
  const domainTag = document.getElementById('domain');
  const btnSignIn = document.getElementById('btnSignIn');
  const btnPay = document.getElementById('btnPay');

  domainTag.textContent = 'Domain: ' + location.hostname;

  function isPiBrowser(){
    return /PiBrowser/i.test(navigator.userAgent) || (window.Pi && typeof Pi.openShareDialog === 'function') || !!window.ReactNativeWebView;
  }

  function setBadge(el, ok, text){
    el.textContent = text;
    el.className = ok ? 'ok' : 'bad';
  }

  function setup(){
    const sdkLoaded = !!window.Pi;
    setBadge(sdkTag, sdkLoaded, 'SDK: ' + (sdkLoaded ? 'loaded' : 'missing'));
    const inPi = isPiBrowser();
    setBadge(browserTag, inPi, 'Pi Browser: ' + (inPi ? 'YES' : 'NO'));

    if (!sdkLoaded){
      log('Pi SDK not available.');
      return;
    }

    try{
      // Testnet mode
      Pi.init({ version: "2.0", sandbox: true });
      log('Pi.init() done (sandbox=true)');
    }catch(e){
      log('Pi.init() error:', e);
      return;
    }

    // Enable Sign-in once SDK is ready
    btnSignIn.disabled = false;

    let currentUser = null;

    btnSignIn.addEventListener('click', async ()=>{
      try{
        const scopes = ['username','payments'];
        currentUser = await Pi.authenticate(scopes, (payment)=>log('Incomplete payment:', payment));
        const uname = currentUser && currentUser.user && currentUser.user.username;
        log('Signed in as', uname);
        alert('Signed in as ' + uname);
        // Enable payment button after successful sign-in
        btnPay.disabled = false;
      }catch(e){
        log('Auth error:', e);
        alert('Auth error: ' + (e && e.message ? e.message : e));
      }
    });

    btnPay.addEventListener('click', async ()=>{
      try{
        await Pi.createPayment({
          amount: 1,
          memo: "Cashflow App Test Payment",
          metadata: { demo: true, ts: Date.now() }
        }, {
          onReadyForServerApproval: (paymentId)=>{ log('Ready for approval:', paymentId); alert('Ready for approval: ' + paymentId); },
          onReadyForServerCompletion: (paymentId)=>{ log('Ready for completion:', paymentId); alert('Ready for completion: ' + paymentId); },
          onCancel: (paymentId)=>{ log('Payment cancelled:', paymentId); alert('Payment cancelled'); },
          onError: (error, payment)=>{ log('Payment error:', error, payment); alert('Payment error: ' + error); }
        });
      }catch(e){
        log('createPayment error:', e);
        alert('createPayment error: ' + (e && e.message ? e.message : e));
      }
    });
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', setup);
  } else {
    setTimeout(setup, 100);
  }
})();
</script>
</body>
</html>