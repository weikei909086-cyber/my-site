<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cashflow App â€“ Pi Auth (username only)</title>
<style>
  :root{--ok:#d4f7d4;--bad:#ffe0e0;--muted:#666;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:20px;line-height:1.45}
  h1{margin:0 0 8px}
  .row{margin:12px 0}
  button{padding:10px 14px;margin:6px 8px 6px 0;border:1px solid #bbb;border-radius:10px;background:#fafafa;cursor:pointer}
  button[disabled]{opacity:.5;cursor:not-allowed}
  #status span{display:inline-block;margin-right:10px;margin-bottom:6px;padding:6px 10px;border-radius:8px;background:#eee}
  .ok{background:var(--ok)}
  .bad{background:var(--bad)}
  pre{white-space:pre-wrap;background:#f6f8fa;padding:12px;border-radius:10px;min-height:100px}
</style>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <h1>Cashflow App â€“ Pi Auth (username only)</h1>
  <div id="status" class="row">
    <span id="sdk">SDK: â€¦</span>
    <span id="browser">Pi Browser (best-effort): â€¦</span>
    <span id="domain"></span>
  </div>

  <div class="row">
    <button id="btnSignIn" disabled>Sign in with Pi</button>
    <button id="btnPay" disabled title="Enable Payments scope in the Pi Portal to use this">Make Payment</button>
  </div>

  <div id="log" class="row"><pre></pre></div>

<script>
(function(){
  const logBox = document.querySelector('#log pre');
  const log = (...args)=>{ console.log(...args); logBox.textContent += args.map(a=>typeof a==='object'?JSON.stringify(a):String(a)).join(' ') + "\n"; };

  const sdkTag = document.getElementById('sdk');
  const browserTag = document.getElementById('browser');
  const domainTag = document.getElementById('domain');
  const btnSignIn = document.getElementById('btnSignIn');
  const btnPay = document.getElementById('btnPay');

  domainTag.textContent = 'Domain: ' + location.hostname;

  function isProbablyPiBrowser(){
    const ua = (navigator.userAgent || '').toLowerCase();
    return ua.includes('pibrowser') || !!window.ReactNativeWebView || (window.Pi && typeof Pi.openShareDialog === 'function');
  }
  function setBadge(el, ok, text){ el.textContent = text; el.className = ok ? 'ok' : 'bad'; }

  function setup(){
    const sdkLoaded = !!window.Pi;
    setBadge(sdkTag, sdkLoaded, 'SDK: ' + (sdkLoaded ? 'loaded' : 'missing'));
    setBadge(browserTag, isProbablyPiBrowser(), 'Pi Browser (best-effort): ' + (isProbablyPiBrowser() ? 'YES' : 'NO'));
    if (!sdkLoaded){ log('Pi SDK not available.'); return; }

    try{
      Pi.init({ version: "2.0", sandbox: true });
      log('Pi.init() done (sandbox=true)');
    }catch(e){ log('Pi.init() error:', e); return; }

    // Enable Sign-in after SDK init
    btnSignIn.disabled = false;

    btnSignIn.addEventListener('click', async ()=>{
      try{
        // ðŸ‘‡ Username only (no payments)
        const res = await Pi.authenticate(['username']);
        const uname = res?.user?.username;
        log('Signed in as', uname);
        alert('Signed in as ' + uname + ' (username scope)');
        // Keep payment disabled until payments scope is enabled in the portal
      }catch(e){
        log('Auth error:', e);
        alert('Auth error: ' + (e?.message || e));
      }
    });

    // Payments stay disabled until you enable the scope in the Portal
    btnPay.addEventListener('click', ()=>{
      alert('Enable the "payments" scope in the Pi Developer Portal, then switch authenticate() to ["username","payments"].');
    });
  }

  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', setup); }
  else { setTimeout(setup, 100); }
})();
</script>
</body>
</html>
